var St=Object.defineProperty;var _t=(i,t,e)=>t in i?St(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var c=(i,t,e)=>_t(i,typeof t!="symbol"?t+"":t,e);import{m as At,n as S,a as Pt,g as Nt,b as Ut,f as xt,c as K,d as j,e as Ct}from"./nostr-tools-BCpAdhG5.js";import{l as N}from"./tseep-BXNw9TWC.js";import{d as x}from"./debug-BtKHo6Hi.js";import{s as lt,a as It,b as ut,h as dt}from"./@noble-D0EBiHBN.js";import{d as ft}from"./typescript-lru-cache-CrdSf7DB.js";import{b as B}from"./@scure-BSzfOT6V.js";import"./light-bolt11-decoder-BzXOEWTB.js";function F(i,t,e="write"){if(!i.outboxTracker)return;const s=i.outboxTracker.data.get(t);if(s)return e==="write"?s.writeRelays:s.readRelays}async function Dt(i,t,e="write"){if(i.outboxTracker)return i.outboxTracker.data.has(t)||await i.outboxTracker.trackUsers([t]),F(i,t,e)}function Mt(i,t){const e=new Map;return t.forEach(n=>{const r=F(i,n);r&&r.forEach(a=>{const o=e.get(a)||0;e.set(a,o+1)})}),Array.from(e.entries()).sort((n,r)=>r[1]-n[1]).map(n=>n[0])}function Ft(i,t,e="read"){const s=new Map,n=new Set;return t.forEach(r=>{const a=F(i,r,e);a&&a.size>0?(a.forEach(o=>{(s.get(o)||new Set).add(r)}),s.set(r,a)):n.add(r)}),{pubkeysToRelays:s,authorsMissingRelays:n}}function pt(i,t,e,{count:s,preferredRelays:n}={}){s??(s=2),n??(n=new Set);const r=i.pool,a=r.connectedRelays();a.forEach(f=>{n.add(f.url)});const o=new Map,{pubkeysToRelays:h,authorsMissingRelays:l}=Ft(i,t,e),u=Mt(i,t),d=(f,p)=>{const y=o.get(p)||[];y.push(f),o.set(p,y)};for(const[f,p]of h.entries()){let y=s;for(const g of a)p.has(g.url)&&(d(f,g.url),y--);for(const g of p)o.has(g)&&(d(f,g),y--);if(!(y<=0))for(const g of u){if(y<=0)break;p.has(g)&&(d(f,g),y--)}}for(const f of l)r.permanentAndConnectedRelays().forEach(p=>{const y=o.get(p.url)||[];y.push(f),o.set(p.url,y)});return o}function zt(i,t,e=2){return pt(i,t,"write",{count:e})}function Y(i){try{return E(i)}catch{return}}function E(i){let t=Ht(i.toLowerCase(),{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return t.endsWith("/")||(t+="/"),t}function Z(i){const t=new Set;for(const e of i)try{t.add(E(e))}catch{}return Array.from(t)}var Kt="text/plain",Lt="us-ascii",L=(i,t)=>t.some(e=>e instanceof RegExp?e.test(i):e===i),$t=new Set(["https:","http:","file:"]),Vt=i=>{try{const{protocol:t}=new URL(i);return t.endsWith(":")&&!t.includes(".")&&!$t.has(t)}catch{return!1}},Ot=(i,{stripHash:t})=>{var d,f,p,y;const e=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(i);if(!e)throw new Error(`Invalid URL: ${i}`);let s=((d=e.groups)==null?void 0:d.type)??"",n=((f=e.groups)==null?void 0:f.data)??"",r=((p=e.groups)==null?void 0:p.hash)??"";const a=s.split(";");r=t?"":r;let o=!1;a[a.length-1]==="base64"&&(a.pop(),o=!0);const h=((y=a.shift())==null?void 0:y.toLowerCase())??"",u=[...a.map(g=>{let[R,b=""]=g.split("=").map(T=>T.trim());return R==="charset"&&(b=b.toLowerCase(),b===Lt)?"":`${R}${b?`=${b}`:""}`}).filter(Boolean)];return o&&u.push("base64"),(u.length>0||h&&h!==Kt)&&u.unshift(h),`data:${u.join(";")},${o?n.trim():n}${r?`#${r}`:""}`};function Ht(i,t){if(t={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...t},typeof t.defaultProtocol=="string"&&!t.defaultProtocol.endsWith(":")&&(t.defaultProtocol=`${t.defaultProtocol}:`),i=i.trim(),/^data:/i.test(i))return Ot(i,t);if(Vt(i))return i;const e=i.startsWith("//");!e&&/^\.*\//.test(i)||(i=i.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,t.defaultProtocol));const n=new URL(i);if(t.forceHttp&&t.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(t.forceHttp&&n.protocol==="https:"&&(n.protocol="http:"),t.forceHttps&&n.protocol==="http:"&&(n.protocol="https:"),t.stripAuthentication&&(n.username="",n.password=""),t.stripHash?n.hash="":t.stripTextFragment&&(n.hash=n.hash.replace(/#?:~:text.*?$/i,"")),n.pathname){const a=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let o=0,h="";for(;;){const u=a.exec(n.pathname);if(!u)break;const d=u[0],f=u.index,p=n.pathname.slice(o,f);h+=p.replace(/\/{2,}/g,"/"),h+=d,o=f+d.length}const l=n.pathname.slice(o,n.pathname.length);h+=l.replace(/\/{2,}/g,"/"),n.pathname=h}if(n.pathname)try{n.pathname=decodeURI(n.pathname)}catch{}if(t.removeDirectoryIndex===!0&&(t.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(t.removeDirectoryIndex)&&t.removeDirectoryIndex.length>0){let a=n.pathname.split("/");const o=a[a.length-1];L(o,t.removeDirectoryIndex)&&(a=a.slice(0,-1),n.pathname=a.slice(1).join("/")+"/")}if(n.hostname&&(n.hostname=n.hostname.replace(/\.$/,""),t.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(n.hostname)&&(n.hostname=n.hostname.replace(/^www\./,""))),Array.isArray(t.removeQueryParameters))for(const a of[...n.searchParams.keys()])L(a,t.removeQueryParameters)&&n.searchParams.delete(a);if(!Array.isArray(t.keepQueryParameters)&&t.removeQueryParameters===!0&&(n.search=""),Array.isArray(t.keepQueryParameters)&&t.keepQueryParameters.length>0)for(const a of[...n.searchParams.keys()])L(a,t.keepQueryParameters)||n.searchParams.delete(a);if(t.sortQueryParameters){n.searchParams.sort();try{n.search=decodeURIComponent(n.search)}catch{}}t.removeTrailingSlash&&(n.pathname=n.pathname.replace(/\/$/,"")),t.removeExplicitPort&&n.port&&(n.port="");const r=i;return i=n.toString(),!t.removeSingleSlash&&n.pathname==="/"&&!r.endsWith("/")&&n.hash===""&&(i=i.replace(/\/$/,"")),(t.removeTrailingSlash||n.pathname==="/")&&n.hash===""&&t.removeSingleSlash&&(i=i.replace(/\/$/,"")),e&&!t.normalizeProtocol&&(i=i.replace(/^http:\/\//,"//")),t.stripProtocol&&(i=i.replace(/^(?:https?:)?\/\//,"")),i}var qt=5,Wt=1e3,Jt=class{constructor(i,t){c(this,"ndkRelay");c(this,"ws");c(this,"_status");c(this,"timeoutMs");c(this,"connectedAt");c(this,"_connectionStats",{attempts:0,success:0,durations:[]});c(this,"debug");c(this,"connectTimeout");c(this,"reconnectTimeout");c(this,"ndk");c(this,"openSubs",new Map);c(this,"openCountRequests",new Map);c(this,"openEventPublishes",new Map);c(this,"serial",0);c(this,"baseEoseTimeout",4400);c(this,"updateConnectionStats",{connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}});this.ndkRelay=i,this._status=1;const e=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend("connectivity"+e),this.ndk=t}async connect(i,t=!0){if(this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),i??(i=this.timeoutMs),!this.timeoutMs&&i&&(this.timeoutMs=i),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(t),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(e){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,e),this._status=1,t?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),e}}disconnect(){var i;this._status=0;try{(i=this.ws)==null||i.close()}catch(t){this.debug("Failed to disconnect",t),this._status=1}}onConnectionError(i){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),i&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.updateConnectionStats.disconnected(),this._status=1}onMessage(i){try{const t=JSON.parse(i.data),[e,s,...n]=t;switch(e){case"EVENT":{const r=this.openSubs.get(s),a=t[2];if(!r){this.debug(`Received event for unknown subscription ${s}`);return}r.onevent(a);return}case"COUNT":{const r=t[2],a=this.openCountRequests.get(s);a&&(a.resolve(r.count),this.openCountRequests.delete(s));return}case"EOSE":{const r=this.openSubs.get(s);if(!r)return;r.oneose(s);return}case"OK":{const r=t[2],a=t[3],o=this.openEventPublishes.get(s),h=o==null?void 0:o.pop();if(!o||!h){this.debug("Received OK for unknown event publish",s);return}r?h.resolve(a):h.reject(new Error(a)),o.length===0?this.openEventPublishes.delete(s):this.openEventPublishes.set(s,o);return}case"CLOSED":{const r=this.openSubs.get(s);if(!r)return;r.onclosed(t[2]);return}case"NOTICE":this.onNotice(t[1]);return;case"AUTH":{this.onAuthRequested(t[1]);return}}}catch(t){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${t.message}`,t==null?void 0:t.stack);return}}async onAuthRequested(i){var e,s,n;const t=this.ndkRelay.authPolicy??((e=this.ndk)==null?void 0:e.relayAuthDefaultPolicy);if(this.debug("Relay requested authentication",{havePolicy:!!t}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,t){if(this._status>=5){this._status=7;let r;try{r=await t(this.ndkRelay,i)}catch(a){this.debug("Authentication policy threw an error",a),r=!1}if(this.debug("Authentication policy returned",!!r),r instanceof m||r===!0){r instanceof m&&await this.auth(r);const a=async()=>{if(this._status>=5&&this._status<8){const o=new m(this.ndk);o.kind=22242,o.tags=[["relay",this.ndkRelay.url],["challenge",i]],await o.sign(),this.auth(o).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful")}).catch(h=>{this._status=6,this.ndkRelay.emit("auth:failed",h),this.debug("Authentication failed",h)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};r===!0&&((s=this.ndk)!=null&&s.signer?a().catch(o=>{console.error("Error authenticating",o)}):(this.debug("No signer available for authentication localhost"),(n=this.ndk)==null||n.once("signer:ready",a))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",i)}onError(i){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,i)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const i=this._connectionStats.durations;if(i.length%3!==0)return!1;const e=i.reduce((a,o)=>a+o,0)/i.length,s=i.map(a=>Math.pow(a-e,2)).reduce((a,o)=>a+o,0)/i.length;return Math.sqrt(s)<Wt}async onNotice(i){this.ndkRelay.emit("notice",i)}handleReconnection(i=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}const t=this.connectedAt?Math.max(0,6e4-(Date.now()-this.connectedAt)):5e3*(this._connectionStats.attempts+1);this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(e=>{i<qt?setTimeout(()=>{this.handleReconnection(i+1)},1e3*(i+1)^4):this.debug("Reconnect failed")})},t),this.ndkRelay.emit("delayed-connect",t),this.debug("Reconnecting in",t),this._connectionStats.nextReconnectAt=Date.now()+t}async send(i){var t,e;this._status>=5&&((t=this.ws)==null?void 0:t.readyState)===WebSocket.OPEN?(e=this.ws)==null||e.send(i):this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${i}`,this._status)}async auth(i){const t=new Promise((e,s)=>{const n=this.openEventPublishes.get(i.id)??[];n.push({resolve:e,reject:s}),this.openEventPublishes.set(i.id,n)});return this.send('["AUTH",'+JSON.stringify(i.rawEvent())+"]"),t}async publish(i){const t=new Promise((e,s)=>{const n=this.openEventPublishes.get(i.id)??[];n.length>0&&console.warn("Duplicate event publishing detected, you are publishing event "+i.id+" twice"),n.push({resolve:e,reject:s}),this.openEventPublishes.set(i.id,n)});return this.send('["EVENT",'+JSON.stringify(i)+"]"),t}async count(i,t){this.serial++;const e=(t==null?void 0:t.id)||"count:"+this.serial,s=new Promise((n,r)=>{this.openCountRequests.set(e,{resolve:n,reject:r})});return this.send('["COUNT","'+e+'",'+JSON.stringify(i).substring(1)),s}close(i,t){this.send('["CLOSE","'+i+'"]');const e=this.openSubs.get(i);this.openSubs.delete(i),e&&e.onclose(t)}req(i){this.send('["REQ","'+i.subId+'",'+JSON.stringify(i.executeFilters).substring(1))+"",this.openSubs.set(i.subId,i)}get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){var i;return this._status>=5&&((i=this.ws)==null?void 0:i.readyState)===WebSocket.OPEN}},jt=class{constructor(i){c(this,"ndkRelay");c(this,"debug");this.ndkRelay=i,this.debug=i.debug.extend("publisher")}async publish(i,t=2500){let e;const s=()=>new Promise((u,d)=>{try{this.publishEvent(i).then(f=>{this.ndkRelay.emit("published",i),i.emit("relay:published",this.ndkRelay),u(!0)}).catch(d)}catch(f){d(f)}}),n=new Promise((u,d)=>{e=setTimeout(()=>{e=void 0,d(new Error("Timeout: "+t+"ms"))},t)}),r=()=>{s().then(u=>a(u)).catch(u=>o(u))};let a,o;const h=u=>{throw this.ndkRelay.debug("Publish failed",u,i.id),this.ndkRelay.emit("publish:failed",i,u),i.emit("relay:publish:failed",this.ndkRelay,u),u},l=()=>{e&&clearTimeout(e),this.ndkRelay.removeListener("connect",r)};return this.ndkRelay.status>=5?Promise.race([s(),n]).catch(h).finally(l):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((u,d)=>{a=u,o=d,this.ndkRelay.once("connect",r)}),n]).catch(h).finally(l))}async publishEvent(i){return this.ndkRelay.connectivity.publish(i.rawEvent())}};function Bt(i,t){const e=[];for(const n of i){if(n.since||n.until)return;const a=Object.keys(n||{}).sort().join("-");e.push(a)}let s=t?"+":"";return s+=e.join("|"),s}function Yt(i){const t={};return i.forEach(e=>{Object.entries(e).forEach(([s,n])=>{Array.isArray(n)?t[s]===void 0?t[s]=[...n]:t[s]=Array.from(new Set([...t[s],...n])):t[s]=n})}),t}var Zt=class{constructor(i,t){c(this,"fingerprint");c(this,"items",new Map);c(this,"topSubscriptionManager");c(this,"debug");c(this,"status",0);c(this,"onClose");c(this,"relay");c(this,"eosed",!1);c(this,"itemsToRemoveAfterEose",[]);c(this,"executionTimer");c(this,"fireTime");c(this,"delayType");c(this,"executeFilters");c(this,"eventIds",new Set);c(this,"_subId");c(this,"subIdParts",new Set);c(this,"executeOnRelayReady",()=>{this.status===2&&(this.status=1,this.execute())});c(this,"reExecuteAfterAuth",(()=>{const i=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:i}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s ðŸ‘‰ %s",i,this.subId)}).bind(this));this.relay=i;const e=Math.random().toString(36).substring(7);this.debug=i.debug.extend("subscription-"+e),this.fingerprint=t||Math.random().toString(36).substring(7)}get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}addSubIdPart(i){this.subIdParts.add(i)}addItem(i,t){if(!this.items.has(i.internalId))switch(i.on("close",this.removeItem.bind(this,i)),this.items.set(i.internalId,{subscription:i,filters:t}),this.status!==3&&i.subId&&(!this._subId||this._subId.length<48)&&(this.status===0||this.status===1)&&this.addSubIdPart(i.subId),this.status){case 0:this.evaluateExecutionPlan(i);break;case 3:break;case 1:this.evaluateExecutionPlan(i);break;case 4:throw this.debug("Subscription is closed, cannot add new items %o (%o)",i,t),new Error("Cannot add new items to a closed subscription")}}removeItem(i){if(!this.eosed){this.itemsToRemoveAfterEose.push(i.internalId);return}this.items.delete(i.internalId),this.items.size===0&&this.close()}close(){if(this.status===4)return;const i=this.status;if(this.status=4,i===3)try{this.relay.close(this.subId)}catch(t){this.debug("Error closing subscription",t,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:i,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}catchUpSubscription(i,t){this.debug("TODO: catch up subscription",i,t)}evaluateExecutionPlan(i){if(!i.isGroupable()){this.status=1,this.execute();return}const t=i.groupableDelay,e=i.groupableDelayType;if(!t)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(t,e);else{const s=this.delayType,n=this.fireTime-Date.now();if(s==="at-least"&&e==="at-least")n<t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,e));else if(s==="at-least"&&e==="at-most")n>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,e));else if(s==="at-most"&&e==="at-most")n>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,e));else if(s==="at-most"&&e==="at-least")n>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,e));else throw new Error("Unknown delay type combination "+s+" "+e)}}schedule(i,t){this.status=1;const e=Date.now();this.fireTime=e+i,this.delayType=t;const s=setTimeout(this.execute.bind(this),i);t==="at-least"&&(this.executionTimer=s)}finalizeSubId(){this.subIdParts.size>0?this._subId=Array.from(this.subIdParts).join("-"):this._subId=this.fingerprint.slice(0,15),this._subId+="-"+Math.random().toString(36).substring(2,7)}execute(){if(this.status===1){if(this.relay.connected)this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth);else{this.status=2,this.relay.once("ready",this.executeOnRelayReady);return}this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(i){var t;(t=this.topSubscriptionManager)==null||t.seenEvent(i.id,this.relay);for(const{subscription:e}of this.items.values())Pt(e.filters,i)&&e.eventReceived(i,this.relay,!1)}oneose(i){if(this.eosed=!0,i!==this.subId){this.debug("Received EOSE for an abandoned subscription",i,this.subId),this.relay.close(i);return}for(const{subscription:t}of this.items.values())t.eoseReceived(this.relay),t.closeOnEose&&this.removeItem(t)}onclose(i){this.status=4}onclosed(i){if(i)for(const{subscription:t}of this.items.values())t.closedReceived(this.relay,i)}compileFilters(){const i=[],t=Array.from(this.items.values()).map(s=>s.filters);t[0]||(this.debug("ðŸ‘€ No filters to merge",this.items),console.trace("No filters to merge"));const e=t[0].length;for(let s=0;s<e;s++){const n=t.map(r=>r[s]);i.push(Yt(n))}return i}},Qt=class{constructor(i,t){c(this,"relay");c(this,"subscriptions");c(this,"topSubscriptionManager");c(this,"debug");this.relay=i,this.subscriptions=new Map,this.debug=i.debug.extend("sub-manager"),this.topSubscriptionManager=t}addSubscription(i,t){let e;if(!i.isGroupable())e=this.createSubscription(i,t);else{const s=Bt(t,i.closeOnEose);s&&(e=this.subscriptions.get(s)),e??(e=this.createSubscription(i,t,s))}e.addItem(i,t)}createSubscription(i,t,e){const s=new Zt(this.relay,e);return s.topSubscriptionManager=this.topSubscriptionManager,s.onClose=this.onRelaySubscriptionClose.bind(this),this.subscriptions.set(s.fingerprint,s),s}onRelaySubscriptionClose(i){this.subscriptions.delete(i.fingerprint)}},U,P=(U=class extends N.EventEmitter{constructor(e,s,n){super();c(this,"url");c(this,"scores");c(this,"connectivity");c(this,"subs");c(this,"publisher");c(this,"authPolicy");c(this,"lowestValidationRatio");c(this,"targetValidationRatio");c(this,"validationRatioFn");c(this,"validatedEventCount",0);c(this,"nonValidatedEventCount",0);c(this,"trusted",!1);c(this,"complaining",!1);c(this,"debug");c(this,"req");c(this,"close");this.url=E(e),this.scores=new Map,this.debug=x(`ndk:relay:${e}`),this.connectivity=new Jt(this,n),this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new Qt(this,n==null?void 0:n.subManager),this.publisher=new jt(this),this.authPolicy=s,this.targetValidationRatio=n==null?void 0:n.initialValidationRatio,this.lowestValidationRatio=n==null?void 0:n.lowestValidationRatio,this.validationRatioFn=((n==null?void 0:n.validationRatioFn)??U.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),n||console.trace("relay created without ndk")}updateValidationRatio(){setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,s=!0){return this.connectivity.connect(e,s)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(e,s){this.subs.addSubscription(e,s)}async publish(e,s=2500){return this.publisher.publish(e,s)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0?!0:this.validationRatio<this.targetValidationRatio}get connected(){return this.connectivity.connected}},c(U,"defaultValidationRatioUpdateFn",(e,s,n)=>{if(e.lowestValidationRatio===void 0||e.targetValidationRatio===void 0)return 1;let r=e.validationRatio;if(e.validationRatio>e.targetValidationRatio){const a=s/100;r=Math.max(e.lowestValidationRatio,e.validationRatio-a)}return r<e.validationRatio?r:e.validationRatio}),U),Gt=class extends Error{constructor(t,e,s,n){super(t);c(this,"errors");c(this,"publishedToRelays");c(this,"intendedRelaySet");this.errors=e,this.publishedToRelays=s,this.intendedRelaySet=n}get relayErrors(){const t=[];for(const[e,s]of this.errors)t.push(`${e.url}: ${s}`);return t.join(`
`)}},w=class yt{constructor(t,e){c(this,"relays");c(this,"debug");c(this,"ndk");this.relays=t,this.ndk=e,this.debug=e.debug.extend("relayset")}addRelay(t){this.relays.add(t)}get relayUrls(){return Array.from(this.relays).map(t=>t.url)}static fromRelayUrls(t,e,s=!0){const n=new Set;for(const r of t){const a=e.pool.relays.get(E(r));if(a)a.status<5&&s&&a.connect(),n.add(a);else{const o=new P(E(r),e==null?void 0:e.relayAuthDefaultPolicy,e);e.pool.useTemporaryRelay(o,void 0,"requested from fromRelayUrls "+t),n.add(o)}}return new yt(new Set(n),e)}async publish(t,e,s=1){const n=new Set,r=new Map,a=t.isEphemeral();t.publishStatus="pending";const o=Array.from(this.relays).map(h=>new Promise(l=>{h.publish(t,e).then(u=>{n.add(h),l()}).catch(u=>{a||r.set(h,u),l()})}));if(await Promise.all(o),n.size<s){if(!a){const h=new Gt("Not enough relays received the event",r,n,this);throw t.publishStatus="error",t.publishError=h,this.ndk.emit("event:publish-failed",t,h,this.relayUrls),h}}else t.emit("published",{relaySet:this,publishedToRelays:n});return n}get size(){return this.relays.size}},$=x("ndk:outbox:calculate");async function Xt(i,t){var a;const e=new Set,s=await Dt(i,t.pubkey);s&&s.forEach(o=>{var l;const h=(l=i.pool)==null?void 0:l.getRelay(o);h&&e.add(h)});let n=t.tags.filter(o=>["a","e"].includes(o[0])).map(o=>o[2]).filter(o=>o&&o.startsWith("wss://")).filter(o=>{try{return new URL(o),!0}catch{return!1}}).map(o=>E(o));n=Array.from(new Set(n)).slice(0,5),n.forEach(o=>{var l;const h=(l=i.pool)==null?void 0:l.getRelay(o,!0,!0);h&&($("Adding relay hint %s",o),e.add(h))});const r=t.getMatchingTags("p").map(o=>o[1]);return r.length<5?Array.from(pt(i,r,"read",{preferredRelays:new Set(s)}).keys()).forEach(h=>{var u;const l=(u=i.pool)==null?void 0:u.getRelay(h,!1,!0);l&&($("Adding p-tagged relay %s",h),e.add(l))}):$("Too many p-tags to consider %d",r.length),(a=i.pool)==null||a.permanentAndConnectedRelays().forEach(o=>e.add(o)),new w(e,i)}function te(i,t,e){const s=new Map,n=new Set;if(t.forEach(r=>{r.authors&&r.authors.forEach(a=>n.add(a))}),n.size>0){const r=zt(i,Array.from(n));for(const a of r.keys())s.set(a,[]);for(const a of t)if(a.authors)for(const[o,h]of r.entries()){const l=a.authors.filter(u=>h.includes(u));s.set(o,[...s.get(o),{...a,authors:l}])}else for(const o of r.keys())s.set(o,[...s.get(o),a])}else i.explicitRelayUrls&&i.explicitRelayUrls.forEach(r=>{s.set(r,t)});return s.size===0&&e.permanentAndConnectedRelays().slice(0,5).forEach(r=>{s.set(r.url,t)}),s.size===0&&console.warn("No relays found for filter",t),s}function H(i,t,e){return te(i,t,e)}function ee(i,t){const e=new Map,s=a=>a.join(","),n=(a,o)=>a.every((h,l)=>h===o[l]),r=a=>{for(const[o,h]of e)if(n(h,a)||n(a,h)){a.length>=h.length&&e.set(o,a);return}e.set(s(a),a)};return i.concat(t).forEach(r),Array.from(e.values())}async function se(i,t=[]){const e=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,s=new RegExp(`(?<=\\s|^)(#[^\\s!@#$%^&*()=+./,[{\\]};:'"?><]+)`,"g"),n=[],r=a=>{t.find(o=>["q",a[0]].includes(o[0])&&o[1]===a[1])||t.push(a)};return i=i.replace(e,a=>{try{const o=a.split(/(@|nostr:)/)[2],{type:h,data:l}=S.decode(o);let u;switch(h){case"npub":u=["p",l];break;case"nprofile":u=["p",l.pubkey];break;case"note":n.push(new Promise(async d=>{r(["e",l,await V(o),"mention"]),d()}));break;case"nevent":n.push(new Promise(async d=>{const{id:f,author:p}=l;let{relays:y}=l;(!y||y.length===0)&&(y=[await V(o)]),r(["e",f,y[0],"mention"]),p&&r(["p",p]),d()}));break;case"naddr":n.push(new Promise(async d=>{const f=[l.kind,l.pubkey,l.identifier].join(":");let p=l.relays??[];p.length===0&&(p=[await V(o)]),r(["a",f,p[0],"mention"]),r(["p",l.pubkey]),d()}));break;default:return a}return u&&r(u),`nostr:${o}`}catch{return a}}),await Promise.all(n),i=i.replace(s,(a,o)=>{const h=["t",o.slice(1)];return t.find(l=>l[0]===h[0]&&l[1]===h[1])||t.push(h),a}),{content:i,tags:t}}async function V(i){return""}function ie(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function ne(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function re(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var M="nip04";async function ae(i,t,e=M){if(!this.ndk)throw new Error("No NDK instance found!");if(t||(await this.ndk.assertSigner(),t=this.ndk.signer),!i){const s=this.getMatchingTags("p");if(s.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");i=this.ndk.getUser({pubkey:s[0][1]})}this.content=await(t==null?void 0:t.encrypt(i,this.content,e))}async function oe(i,t,e=M){if(!this.ndk)throw new Error("No NDK instance found!");t||(await this.ndk.assertSigner(),t=this.ndk.signer),i||(i=this.author),this.content=await(t==null?void 0:t.decrypt(i,this.content,e))}function ce(i=5){let t=[];return this.onRelays.length>0?t=this.onRelays.map(e=>e.url):this.relay&&(t=[this.relay.url]),t.length>i&&(t=t.slice(0,i)),this.isParamReplaceable()?S.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:t}):t.length>0?S.neventEncode({id:this.tagId(),relays:t,author:this.pubkey}):S.noteEncode(this.tagId())}async function he(i=!0,t){if(!t&&i){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),t=this.ndk.signer}const e=new m(this.ndk,{kind:le(this),content:""});return e.tag(this),e.kind===16?e.tags.push(["k",`${this.kind}`]):e.content=JSON.stringify(this.rawEvent()),t&&await e.sign(t),i&&await e.publish(),e}function le(i){return i.kind===1?6:16}function gt(i){return i.getMatchingTags("e").some(t=>t[3])}function ue(i,t){t??(t=i.tagType());const e=i.tags.find(s=>s[3]==="root");if(!e){if(gt(i))return;const s=i.getMatchingTags(t);if(s.length<3)return s[0]}return e}function de(i,t){t??(t=i.tagType());let e=i.tags.find(s=>s[3]==="reply");if(e)return e;if(e||(e=i.tags.find(s=>s[3]==="root")),!e){if(gt(i))return;const s=i.getMatchingTags(t);if(s.length===1)return s[0];if(s.length===2)return s[1]}}async function fe(i,t){if(!this.ndk)throw new Error("NDK instance not found");const e=this.getMatchingTags(i,t);if(e.length===0)return;const[s,n,r]=e[0];return await this.ndk.fetchEvent(n,{},void 0)}async function pe(i){if(!this.ndk)throw new Error("NDK instance not found");const t=ue(this);if(t)return this.ndk.fetchEventFromTag(t,this,i)}async function ye(i){if(!this.ndk)throw new Error("NDK instance not found");const t=de(this);if(t)return this.ndk.fetchEventFromTag(t,this,i)}function ge(i=!1,t=!1){const e=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return i&&e.push(this.sig),t&&e.push(this.id),JSON.stringify(e)}function me(i){const t=JSON.parse(i),e={pubkey:t[1],created_at:t[2],kind:t[3],tags:t[4],content:t[5]};return t.length===7&&(e.sig=t[6]),t.length===8&&(e.id=t[7]),e}var q,D={};function be(i){q=i,q.onmessage=t=>{const[e,s]=t.data,n=D[e];if(!n){console.error("No record found for event",e);return}delete D[e];for(const r of n.resolves)r(s)}}async function we(i,t){return new Promise(s=>{const n=i.serialize();let r=!1;D[i.id]||(D[i.id]={event:i,resolves:[]},r=!0),D[i.id].resolves.push(s),r&&q.postMessage({serialized:n,id:i.id,sig:i.sig,pubkey:i.pubkey})})}var ke=/^[a-f0-9]{64}$/;function Re(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(ke)||!Array.isArray(this.tags))return!1;for(let i=0;i<this.tags.length;i++){const t=this.tags[i];if(!Array.isArray(t))return!1;for(let e=0;e<t.length;e++)if(typeof t[e]=="object")return!1}return!0}var C=new ft.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function ve(i){var e;if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const t=C.get(this.id);if(t!==null)return this.signatureVerified=!!t;try{if((e=this.ndk)!=null&&e.asyncSigVerification)we(this,i).then(s=>{i&&(this.signatureVerified=s,s&&C.set(this.id,this.sig)),s||(this.ndk.emit("event:invalid-sig",this),C.set(this.id,!1))});else{const s=lt(new TextEncoder().encode(this.serialize())),n=It.verify(this.sig,s,this.pubkey);return n?C.set(this.id,this.sig):C.set(this.id,!1),this.signatureVerified=n}}catch{return this.signatureVerified=!1}}function Ee(){return Te(this.serialize())}function Te(i){const t=lt(new TextEncoder().encode(i));return ut(t)}var Se=[3],m=class I extends N.EventEmitter{constructor(e,s){var n;super();c(this,"ndk");c(this,"created_at");c(this,"content","");c(this,"tags",[]);c(this,"kind");c(this,"id","");c(this,"sig");c(this,"pubkey","");c(this,"signatureVerified");c(this,"_author");c(this,"relay");c(this,"publishStatus","success");c(this,"publishError");c(this,"serialize",ge.bind(this));c(this,"getEventHash",Ee.bind(this));c(this,"validate",Re.bind(this));c(this,"verifySignature",ve.bind(this));c(this,"isReplaceable",ie.bind(this));c(this,"isEphemeral",ne.bind(this));c(this,"isParamReplaceable",re.bind(this));c(this,"encode",ce.bind(this));c(this,"encrypt",ae.bind(this));c(this,"decrypt",oe.bind(this));c(this,"fetchTaggedEvent",fe.bind(this));c(this,"fetchRootEvent",pe.bind(this));c(this,"fetchReplyEvent",ye.bind(this));c(this,"repost",he.bind(this));this.ndk=e,this.created_at=s==null?void 0:s.created_at,this.content=(s==null?void 0:s.content)||"",this.tags=(s==null?void 0:s.tags)||[],this.id=(s==null?void 0:s.id)||"",this.sig=s==null?void 0:s.sig,this.pubkey=(s==null?void 0:s.pubkey)||"",this.kind=s==null?void 0:s.kind,s instanceof I&&(this.relay&&(this.relay=s.relay,(n=this.ndk)==null||n.subManager.seenEvent(s.id,this.relay)),this.publishStatus=s.publishStatus,this.publishError=s.publishError)}get onRelays(){let e=[];return this.ndk?e=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&e.push(this.relay),e}static deserialize(e,s){return new I(e,me(s))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){var s;this.pubkey=e.pubkey,this._author=e,(s=this._author).ndk??(s.ndk=this.ndk)}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tagExternal(e,s,n){let r=["i"],a=["k"];switch(s){case"url":const o=new URL(e);o.hash="",r.push(o.toString()),a.push(`${o.protocol}//${o.host}`);break;case"hashtag":r.push(`#${e.toLowerCase()}`),a.push("#");break;case"geohash":r.push(`geo:${e.toLowerCase()}`),a.push("geo");break;case"isbn":r.push(`isbn:${e.replace(/-/g,"")}`),a.push("isbn");break;case"podcast:guid":r.push(`podcast:guid:${e}`),a.push("podcast:guid");break;case"podcast:item:guid":r.push(`podcast:item:guid:${e}`),a.push("podcast:item:guid");break;case"podcast:publisher:guid":r.push(`podcast:publisher:guid:${e}`),a.push("podcast:publisher:guid");break;case"isan":r.push(`isan:${e.split("-").slice(0,4).join("-")}`),a.push("isan");break;case"doi":r.push(`doi:${e.toLowerCase()}`),a.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${s}`)}n&&r.push(n),this.tags.push(r),this.tags.push(a)}tag(e,s,n,r){let a=[];if(e.fetchProfile!==void 0){r??(r="p");const h=[r,e.pubkey];s&&h.push("",s),a.push(h)}else if(e instanceof I){const h=e;n??(n=(h==null?void 0:h.pubkey)===this.pubkey),a=h.referenceTags(s,n,r);for(const l of h.getMatchingTags("p"))l[1]!==this.pubkey&&(this.tags.find(u=>u[0]==="p"&&u[1]===l[1])||this.tags.push(["p",l[1]]))}else if(Array.isArray(e))a=[e];else throw new Error("Invalid argument",e);this.tags=ee(this.tags,a)}async toNostrEvent(e){var r,a;if(!e&&this.pubkey===""){const o=await((a=(r=this.ndk)==null?void 0:r.signer)==null?void 0:a.user());this.pubkey=(o==null?void 0:o.pubkey)||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:s,tags:n}=await this.generateTags();this.content=s||"",this.tags=n;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}getMatchingTags(e,s){const n=this.tags.filter(r=>r[0]===e);return s===void 0?n:n.filter(r=>r[3]===s)}hasTag(e,s){return this.tags.some(n=>n[0]===e&&(!s||n[3]===s))}tagValue(e){const s=this.getMatchingTags(e);if(s.length!==0)return s[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e){const s=Array.isArray(e)?e:[e];this.tags=this.tags.filter(n=>!s.includes(n[0]))}async sign(e){var n;e?this.author=await e.user():((n=this.ndk)==null||n.assertSigner(),e=this.ndk.signer);const s=await this.toNostrEvent();return this.sig=await e.sign(s),this.sig}async publishReplaceable(e,s,n){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(e,s,n)}async publish(e,s,n){var o,h;if(this.sig||await this.sign(),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");e||(e=this.ndk.devWriteRelaySet||await Xt(this.ndk,this)),this.kind===5&&((o=this.ndk.cacheAdapter)!=null&&o.deleteEvent)&&this.ndk.cacheAdapter.deleteEvent(this);const r=this.rawEvent();if((h=this.ndk.cacheAdapter)!=null&&h.addUnpublishedEvent)try{this.ndk.cacheAdapter.addUnpublishedEvent(this,e.relayUrls)}catch(l){console.error("Error adding unpublished event to cache",l)}this.ndk.subManager.subscriptions.forEach(l=>{l.filters.some(u=>At(u,r))&&l.eventReceived(this,void 0,!1,!0)});const a=await e.publish(this,s,n);return a.forEach(l=>{var u;return(u=this.ndk)==null?void 0:u.subManager.seenEvent(this.id,l)}),a}async generateTags(){var r,a;let e=[];const s=await se(this.content,this.tags),n=s.content;if(e=s.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const h=this.tagValue("title");let u=[...Array(h?6:16)].map(()=>Math.random().toString(36)[2]).join("");h&&h.length>0&&(u=h.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")+"-"+u),e.push(["d",u])}if(((r=this.ndk)!=null&&r.clientName||(a=this.ndk)!=null&&a.clientNip89)&&Se.includes(this.kind)&&!this.tags.some(o=>o[0]==="client")){const o=["client",this.ndk.clientName??""];this.ndk.clientNip89&&o.push(this.ndk.clientNip89),e.push(o)}return{content:n||"",tags:e}}muted(){var r,a;const e=(r=this.ndk)==null?void 0:r.mutedIds.get(this.pubkey);if(e&&e==="p")return"author";const s=this.tagReference(),n=(a=this.ndk)==null?void 0:a.mutedIds.get(s[1]);return n&&n===s[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const e=this.getMatchingTags("d")[0];return e?e[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(!this.isParamReplaceable())throw new Error("This must only be called on replaceable events");const e=this.replaceableDTag();return`${this.kind}:${this.pubkey}:${e}`}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let s;return this.isParamReplaceable()?s=["a",this.tagAddress()]:s=["e",this.tagId()],this.relay?s.push(this.relay.url):s.push(""),e&&s.push(e),s}referenceTags(e,s,n){var a;let r=[];return this.isParamReplaceable()?r=[[n??"a",this.tagAddress()],[n??"e",this.id]]:r=[[n??"e",this.id]],(a=this.relay)!=null&&a.url?r=r.map(o=>{var h;return o.push((h=this.relay)==null?void 0:h.url),o}):e&&(r=r.map(o=>(o.push(""),o))),e&&r.forEach(o=>o.push(e)),r=[...r,...this.getMatchingTags("h")],s||r.push(...this.author.referenceTags()),r}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}async delete(e,s=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const n=new I(this.ndk,{kind:5,content:e||""});return n.tag(this,void 0,!0),n.tags.push(["k",this.kind.toString()]),s&&await n.publish(),n}async react(e,s=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const n=new I(this.ndk,{kind:7,content:e});return n.tag(this),s?await n.publish():await n.sign(),n}get isValid(){return this.validate()}};function Q(i){return!!(_e(i.filter)&&Ae(i))}function _e(i){return!!i.ids}function Ae(i){const t=i.filter.ids;return!!t&&t.length===i.eventFirstSeen.size}function Pe(i){let t;if(i.match(mt)){const[e,s,n]=i.split(":"),r={authors:[s],kinds:[parseInt(e)]};return n&&(r["#d"]=[n]),r}if(i.match(Ue))try{switch(t=S.decode(i),t.type){case"nevent":{const s={ids:[t.data.id]};return t.data.author&&(s.authors=[t.data.author]),t.data.kind&&(s.kinds=[t.data.kind]),s}case"note":return{ids:[t.data]};case"naddr":const e={authors:[t.data.pubkey],kinds:[t.data.kind]};return t.data.identifier&&(e["#d"]=[t.data.identifier]),e}}catch(e){console.error("Error decoding",i,e)}return{ids:[i]}}function Ne(i){return i.match(mt)!==null}var mt=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,Ue=/^n(event|ote|profile|pub|addr)1[\d\w]+$/;function xe(i,t){try{const e=S.decode(i);if(["naddr","nevent"].includes(e==null?void 0:e.type)){const s=e.data;if(s!=null&&s.relays)return s.relays.map(n=>new P(n,t==null?void 0:t.relayAuthDefaultPolicy,t))}}catch{}return[]}var Ce={closeOnEose:!1,cacheUsage:"CACHE_FIRST",groupable:!0,groupableDelay:100,groupableDelayType:"at-most"},Ie=class extends N.EventEmitter{constructor(t,e,s,n,r){super();c(this,"subId");c(this,"filters");c(this,"opts");c(this,"pool");c(this,"skipVerification",!1);c(this,"skipValidation",!1);c(this,"relayFilters");c(this,"relaySet");c(this,"ndk");c(this,"debug");c(this,"eventFirstSeen",new Map);c(this,"eosesSeen",new Set);c(this,"lastEventReceivedAt");c(this,"internalId");c(this,"closeOnEose");c(this,"poolMonitor");c(this,"eoseTimeout");c(this,"eosed",!1);if(this.ndk=t,this.pool=(s==null?void 0:s.pool)||t.pool,this.opts={...Ce,...s||{}},this.filters=e instanceof Array?e:[e],this.subId=r||(s==null?void 0:s.subId),this.internalId=Math.random().toString(36).substring(7),this.relaySet=n,this.debug=t.debug.extend(`subscription[${(s==null?void 0:s.subId)??this.internalId}]`),this.skipVerification=(s==null?void 0:s.skipVerification)||!1,this.skipValidation=(s==null?void 0:s.skipValidation)||!1,this.closeOnEose=(s==null?void 0:s.closeOnEose)||!1,this.opts.cacheUsage==="ONLY_CACHE"&&!this.opts.closeOnEose)throw new Error("Cannot use cache-only options with a persistent subscription")}relaysMissingEose(){return this.relayFilters?Array.from(this.relayFilters.keys()).filter(e=>!this.eosesSeen.has(this.pool.getRelay(e,!1,!1))):[]}get filter(){return this.filters[0]}get groupableDelay(){var t;if(this.isGroupable())return(t=this.opts)==null?void 0:t.groupableDelay}get groupableDelayType(){var t;return((t=this.opts)==null?void 0:t.groupableDelayType)||"at-most"}isGroupable(){var t;return((t=this.opts)==null?void 0:t.groupable)||!1}shouldQueryCache(){var t;return((t=this.opts)==null?void 0:t.cacheUsage)!=="ONLY_RELAY"}shouldQueryRelays(){var t;return((t=this.opts)==null?void 0:t.cacheUsage)!=="ONLY_CACHE"}shouldWaitForCache(){var t;return this.opts.closeOnEose&&!!((t=this.ndk.cacheAdapter)!=null&&t.locking)&&this.opts.cacheUsage!=="PARALLEL"}async start(){let t;if(this.shouldQueryCache()&&(t=this.startWithCache(),this.shouldWaitForCache()&&(await t,Q(this)))){this.emit("eose",this);return}this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=t=>{var s,n;if((s=this.relayFilters)!=null&&s.has(t.url))return;H(this.ndk,this.filters,this.pool).get(t.url)&&((n=this.relayFilters)==null||n.set(t.url,this.filters),t.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}stop(){this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),this.removeAllListeners()}hasAuthorsFilter(){return this.filters.some(t=>{var e;return(e=t.authors)==null?void 0:e.length})}async startWithCache(){var t;if((t=this.ndk.cacheAdapter)!=null&&t.query){const e=this.ndk.cacheAdapter.query(this);this.ndk.cacheAdapter.locking&&await e}}startWithRelays(){if(!this.relaySet||this.relaySet.relays.size===0)this.relayFilters=H(this.ndk,this.filters,this.pool);else{this.relayFilters=new Map;for(const t of this.relaySet.relays)this.relayFilters.set(t.url,this.filters)}if(!(!this.relayFilters||this.relayFilters.size===0))for(const[t,e]of this.relayFilters)this.pool.getRelay(t,!0,!0,e).subscribe(this,e)}eventReceived(t,e,s=!1,n=!1){const r=t.id,a=this.eventFirstSeen.has(r);let o;if(t instanceof m&&(o=t),a){const h=Date.now()-(this.eventFirstSeen.get(r)||0);if(this.emit("event:dup",r,e,h,this),e){const l=C.get(r);l&&typeof l=="string"&&t.sig===l&&e.addValidatedEvent()}}else{if(o??(o=new m(this.ndk,t)),o.ndk=this.ndk,o.relay=e,!s&&!n){if(!this.skipValidation&&!o.isValid){this.debug("Event failed validation %s from relay %s",r,e==null?void 0:e.url);return}if(e)if((e==null?void 0:e.shouldValidateEvent())!==!1){if(!this.skipVerification)if(!o.verifySignature(!0)&&!this.ndk.asyncSigVerification){this.debug("Event failed signature validation",t);return}else e&&e.addValidatedEvent()}else e.addNonValidatedEvent();this.ndk.cacheAdapter&&this.ndk.cacheAdapter.setEvent(o,this.filters,e)}!s&&e&&this.ndk.emit("event",o,e),this.emit("event",o,e,this),this.eventFirstSeen.set(r,Date.now())}this.lastEventReceivedAt=Date.now()}closedReceived(t,e){this.emit("closed",t,e)}eoseReceived(t){var a;this.debug("EOSE received from %s",t.url),this.eosesSeen.add(t);let e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0;const s=this.eosesSeen.size===((a=this.relayFilters)==null?void 0:a.size),n=Q(this),r=o=>{var h;this.debug("Performing EOSE: %s %d",o,this.eosed),!this.eosed&&(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.emit("eose",this),this.eosed=!0,(h=this.opts)!=null&&h.closeOnEose&&this.stop())};if(n||s)r("query filled or seen all");else if(this.relayFilters){let o=1e3;const h=new Set(this.pool.connectedRelays().map(d=>d.url)),l=Array.from(this.relayFilters.keys()).filter(d=>h.has(d));if(l.length===0)return;const u=this.eosesSeen.size/l.length;if(this.eosesSeen.size>=2&&u>=.5){if(o=o*(1-u),o===0){r("tiem to wait was 0");return}this.eoseTimeout&&clearTimeout(this.eoseTimeout);const d=()=>{e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,e!==void 0&&e<20?this.eoseTimeout=setTimeout(d,o):r("send eose timeout: "+o)};this.eoseTimeout=setTimeout(d,o)}}}};async function De(i,t,e=3){var n,r;if(!this.ndk)throw new Error("NDK not set");const s=await this.ndk.fetchEvent({kinds:[e],authors:[this.pubkey]},i||{groupable:!1});if(s){const a=new Set;return s.tags.forEach(o=>{o[0]==="p"&&a.add(o[1])}),t&&((r=(n=this.ndk)==null?void 0:n.outboxTracker)==null||r.trackUsers(Array.from(a))),[...a].reduce((o,h)=>{const l=new k({pubkey:h});return l.ndk=this.ndk,o.add(l),o},new Set)}return new Set}function G(i){const t={};let e;try{e=JSON.parse(i.content)}catch(s){throw new Error(`Failed to parse profile event: ${s}`)}return t.created_at=i.created_at,t.profileEvent=JSON.stringify(i.rawEvent()),Object.keys(e).forEach(s=>{switch(s){case"name":t.name=e.name;break;case"display_name":t.displayName=e.display_name;break;case"image":case"picture":t.image=e.picture||e.image;break;case"banner":t.banner=e.banner;break;case"bio":t.bio=e.bio;break;case"nip05":t.nip05=e.nip05;break;case"lud06":t.lud06=e.lud06;break;case"lud16":t.lud16=e.lud16;break;case"about":t.about=e.about;break;case"zapService":t.zapService=e.zapService;break;case"website":t.website=e.website;break;default:t[s]=e[s];break}}),t}function Me(i){const t={};for(const[e,s]of Object.entries(i))switch(e){case"username":case"name":t.name=s;break;case"displayName":t.display_name=s;break;case"image":case"picture":t.picture=s;break;case"bio":case"about":t.about=s;break;default:t[e]=s;break}return JSON.stringify(t)}var Fe=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function X(i,t,e=fetch,s={}){return await i.queuesNip05.add({id:t,func:async()=>{if(i.cacheAdapter&&i.cacheAdapter.loadNip05){const h=await i.cacheAdapter.loadNip05(t);if(h!=="missing"){if(h){const l=new k({pubkey:h.pubkey,relayUrls:h.relays,nip46Urls:h.nip46});return l.ndk=i,l}else if(s.cache!=="no-cache")return null}}const n=t.match(Fe);if(!n)return null;const[r,a="_",o]=n;try{const h=await e(`https://${o}/.well-known/nostr.json?name=${a}`,s),{names:l,relays:u,nip46:d}=ze(await h.json()),f=l[a.toLowerCase()];let p=null;return f&&(p={pubkey:f,relays:u==null?void 0:u[f],nip46:d==null?void 0:d[f]}),i!=null&&i.cacheAdapter&&i.cacheAdapter.saveNip05&&i.cacheAdapter.saveNip05(t,p),p}catch(h){return i!=null&&i.cacheAdapter&&i.cacheAdapter.saveNip05&&(i==null||i.cacheAdapter.saveNip05(t,null)),console.error("Failed to fetch NIP05 for",t,h),null}}})}function ze(i){const t={names:{}};for(const[e,s]of Object.entries(i.names))typeof e=="string"&&typeof s=="string"&&(t.names[e.toLowerCase()]=s);if(i.relays){t.relays={};for(const[e,s]of Object.entries(i.relays))typeof e=="string"&&Array.isArray(s)&&(t.relays[e]=s.filter(n=>typeof n=="string"))}if(i.nip46){t.nip46={};for(const[e,s]of Object.entries(i.nip46))typeof e=="string"&&Array.isArray(s)&&(t.nip46[e]=s.filter(n=>typeof n=="string"))}return t}var _,Ke=(_=class extends m{constructor(e,s){super(e,s);c(this,"_p2pk");this.kind??(this.kind=10019)}static from(e){return new _(e.ndk,e)}set relays(e){this.tags=this.tags.filter(s=>s[0]!=="relay");for(const s of e)this.tags.push(["relay",s])}get relays(){const e=[];for(const s of this.tags)s[0]==="relay"&&e.push(s[1]);return e}set mints(e){this.tags=this.tags.filter(s=>s[0]!=="mint");for(const s of e)this.tags.push(["mint",s])}get mints(){const e=[];for(const s of this.tags)s[0]==="mint"&&e.push(s[1]);return Array.from(new Set(e))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(e){this._p2pk=e,this.removeTag("pubkey"),e&&this.tags.push(["pubkey",e])}get relaySet(){return w.fromRelayUrls(this.relays,this.ndk)}},c(_,"kind",10019),c(_,"kinds",[10019]),_),Le=x("ndk:zapper:ln");async function tt({lud06:i,lud16:t},e){let s;if(t&&!t.startsWith("LNURL")){const[n,r]=t.split("@");s=`https://${r}/.well-known/lnurlp/${n}`}else if(i){const{words:n}=B.decode(i,1e3),r=B.fromWords(n);s=new TextDecoder("utf-8").decode(r)}if(!s)throw Le("No zap endpoint found %o",{lud06:i,lud16:t}),new Error("No zap endpoint found");try{const r=await(e.httpFetch||fetch)(s);if(r.status!==200){const a=await r.text();throw new Error(`Unable to fetch zap endpoint ${s}: ${a}`)}return await r.json()}catch(n){throw new Error(`Unable to fetch zap endpoint ${s}: ${n}`)}}var k=class bt{constructor(t){c(this,"ndk");c(this,"profile");c(this,"_npub");c(this,"_pubkey");c(this,"relayUrls",[]);c(this,"nip46Urls",[]);c(this,"follows",De.bind(this));t.npub&&(this._npub=t.npub),t.hexpubkey&&(this._pubkey=t.hexpubkey),t.pubkey&&(this._pubkey=t.pubkey),t.relayUrls&&(this.relayUrls=t.relayUrls),t.nip46Urls&&(this.nip46Urls=t.nip46Urls)}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=S.npubEncode(this.pubkey)}return this._npub}set npub(t){this._npub=t}get hexpubkey(){return this.pubkey}set hexpubkey(t){this._pubkey=t}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=S.decode(this.npub).data}return this._pubkey}set pubkey(t){this._pubkey=t}async getZapInfo(t=!0,e=["nip61","nip57"]){if(!this.ndk)throw new Error("No NDK instance found");const s=[];if(e.includes("nip61")&&s.push(10019),e.includes("nip57")&&s.push(0),s.length===0)return[];let n=await this.ndk.fetchEvents({kinds:s,authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",groupable:!1});n.size<e.length&&(n=await this.ndk.fetchEvents({kinds:s,authors:[this.pubkey]},{cacheUsage:"ONLY_RELAY"}));const r=[],a=Array.from(n).find(h=>h.kind===10019),o=Array.from(n).find(h=>h.kind===0);if(a){const h=Ke.from(a);if(h.mints.length>0&&r.push({type:"nip61",data:{mints:h.mints,relays:h.relays,p2pk:h.p2pk}}),!t)return r}if(o){const h=G(o),{lud06:l,lud16:u}=h;try{const d=await tt({lud06:l,lud16:u},this.ndk);d&&r.push({type:"nip57",data:d})}catch(d){console.error("Error getting NIP-57 zap spec",d)}}return r}async getZapConfiguration(t){if(t??(t=this.ndk),!t)throw new Error("No NDK instance found");const e=async()=>{var n,r,a,o;if((r=(n=this.ndk)==null?void 0:n.cacheAdapter)!=null&&r.loadUsersLNURLDoc){const h=await this.ndk.cacheAdapter.loadUsersLNURLDoc(this.pubkey);if(h!=="missing"){if(h===null)return;if(h)return h}}let s;try{if(await this.fetchProfile({groupable:!1}),this.profile){const{lud06:h,lud16:l}=this.profile;s=await tt({lud06:h,lud16:l},t)}}catch{}if((o=(a=this.ndk)==null?void 0:a.cacheAdapter)!=null&&o.saveUsersLNURLDoc&&this.ndk.cacheAdapter.saveUsersLNURLDoc(this.pubkey,s||null),!!s)return s};return await t.queuesZapConfig.add({id:this.pubkey,func:e})}async getZapperPubkey(){const t=await this.getZapConfiguration();return t==null?void 0:t.nostrPubkey}static async fromNip05(t,e,s=!1){if(!e)throw new Error("No NDK instance found");const n={};s&&(n.cache="no-cache");const r=await X(e,t,e==null?void 0:e.httpFetch,n);if(r){const a=new bt({pubkey:r.pubkey,relayUrls:r.relays,nip46Urls:r.nip46});return a.ndk=e,a}}async fetchProfile(t,e=!1){if(!this.ndk)throw new Error("NDK not set");this.profile||(this.profile={});let s=null;if(this.ndk.cacheAdapter&&this.ndk.cacheAdapter.fetchProfile&&(t==null?void 0:t.cacheUsage)!=="ONLY_RELAY"){const a=await this.ndk.cacheAdapter.fetchProfile(this.pubkey);if(a)return this.profile=a,a}!t&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.locking&&(s=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",closeOnEose:!0,groupable:!1}),t={cacheUsage:"ONLY_RELAY",closeOnEose:!0,groupable:!0,groupableDelay:250}),(!s||s.size===0)&&(s=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},t));const n=Array.from(s).sort((a,o)=>a.created_at-o.created_at);if(n.length===0)return null;const r=n[0];return this.profile=G(r),e&&(this.profile.profileEvent=JSON.stringify(r)),this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile}tagReference(){return["p",this.pubkey]}referenceTags(t){const e=[["p",this.pubkey]];return t&&e[0].push("",t),e}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new m(this.ndk,{kind:0,content:Me(this.profile)}).publish()}async follow(t,e,s=3){if(!this.ndk)throw new Error("No NDK instance found");if(this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,s)),e.has(t))return!1;e.add(t);const n=new m(this.ndk,{kind:s});for(const r of e)n.tag(r);return await n.publish(),!0}async unfollow(t,e,s=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,s));const n=new Set;let r=!1;for(const o of e)o.pubkey!==t.pubkey?n.add(o):r=!0;if(!r)return!1;const a=new m(this.ndk,{kind:s});for(const o of n)a.tag(o);return await a.publish()}async validateNip05(t){if(!this.ndk)throw new Error("No NDK instance found");const e=await X(this.ndk,t);return e===null?null:e.pubkey===this.pubkey}async zap(t,e,s,n){return new Promise((r,a)=>{var l;if(!this.ndk){a("No NDK instance found");return}let o=(l=this.ndk.walletConfig)==null?void 0:l.onLnPay;o??(o=async({pr:u})=>{r(u)}),this.ndk.zap(this,t,{comment:e,tags:s,signer:n,onLnPay:o}).zap().then(r).catch(a)})}},$e=class wt extends m{constructor(e,s){super(e,s);c(this,"_encryptedTags");c(this,"encryptedTagsLength");this.kind??(this.kind=30001)}static from(e){return new wt(e.ndk,e)}get title(){const e=this.tagValue("title")||this.tagValue("name");return e||(this.kind===3?"Contacts":this.kind===1e4?"Mute":this.kind===10001?"Pinned Notes":this.kind===10002?"Relay Metadata":this.kind===10003?"Bookmarks":this.kind===10004?"Communities":this.kind===10005?"Public Chats":this.kind===10006?"Blocked Relays":this.kind===10007?"Search Relays":this.kind===10050?"Direct Message Receive Relays":this.kind===10015?"Interests":this.kind===10030?"Emojis":this.tagValue("d"))}set title(e){this.removeTag(["title","name"]),e&&this.tags.push(["title",e])}get name(){return this.title}set name(e){this.title=e}get description(){return this.tagValue("description")}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(e=!0){if(e&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const s=await this.ndk.signer.user();try{if(this.content.length>0)try{const n=await this.ndk.signer.decrypt(s,this.content),r=JSON.parse(n);return r&&r[0]?(this.encryptedTagsLength=this.content.length,this._encryptedTags=r):(this.encryptedTagsLength=this.content.length,this._encryptedTags=[])}catch{console.log(`error decrypting ${this.content}`)}}catch{}return[]}validateTag(e){return!0}getItems(e){return this.tags.filter(s=>s[0]===e)}get items(){return this.tags.filter(e=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(e[0]))}async addItem(e,s=void 0,n=!1,r="bottom"){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");let a;if(e instanceof m)a=[e.tagReference(s)];else if(e instanceof k)a=e.referenceTags();else if(e instanceof P)a=e.referenceTags();else if(Array.isArray(e))a=[e];else throw new Error("Invalid object type");if(s&&a[0].push(s),n){const o=await this.ndk.signer.user(),h=await this.encryptedTags();r==="top"?h.unshift(...a):h.push(...a),this._encryptedTags=h,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(h),await this.encrypt(o)}else r==="top"?this.tags.unshift(...a):this.tags.push(...a);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(e,s=!0){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const n=this.tags.findIndex(h=>h[1]===e);n>=0&&this.tags.splice(n,1);const r=await this.ndk.signer.user(),a=await this.encryptedTags(),o=a.findIndex(h=>h[1]===e);if(o>=0&&(a.splice(o,1),this._encryptedTags=a,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(a),await this.encrypt(r)),s)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(e,s){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");if(s){const n=await this.ndk.signer.user(),r=await this.encryptedTags();r.splice(e,1),this._encryptedTags=r,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(r),await this.encrypt(n)}else this.tags.splice(e,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(e){return this.items.some(s=>s[1]===e)}filterForItems(){const e=new Set,s=new Map,n=[];for(const r of this.items)if(r[0]==="e"&&r[1])e.add(r[1]);else if(r[0]==="a"&&r[1]){const[a,o,h]=r[1].split(":");if(!a||!o)continue;const l=`${a}:${o}`,u=s.get(l)||[];u.push(h||""),s.set(l,u)}if(e.size>0&&n.push({ids:Array.from(e)}),s.size>0)for(const[r,a]of s.entries()){const[o,h]=r.split(":");n.push({kinds:[parseInt(o)],authors:[h],"#d":a})}return n}},kt=$e,et="read",st="write",W=class Rt extends m{constructor(t,e){super(t,e),this.kind??(this.kind=10002)}static from(t){return new Rt(t.ndk,t.rawEvent())}get readRelayUrls(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").filter(t=>!t[2]||t[2]&&t[2]===et).map(t=>Y(t[1])).filter(t=>!!t)}set readRelayUrls(t){for(const e of t)this.tags.push(["r",e,et])}get writeRelayUrls(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").filter(t=>!t[2]||t[2]&&t[2]===st).map(t=>Y(t[1])).filter(t=>!!t)}set writeRelayUrls(t){for(const e of t)this.tags.push(["r",e,st])}get bothRelayUrls(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").filter(t=>!t[2]).map(t=>t[1])}set bothRelayUrls(t){for(const e of t)this.tags.push(["r",e])}get relays(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").map(t=>t[1])}get relaySet(){if(!this.ndk)throw new Error("NDKRelayList has no NDK instance");return new w(new Set(this.relays.map(t=>this.ndk.pool.getRelay(t))),this.ndk)}};function it(i,t){try{const e=JSON.parse(t.content),s=new W(i),n=new Set,r=new Set;for(let[a,o]of Object.entries(e)){try{a=E(a)}catch{continue}if(!o)n.add(a),r.add(a);else{const h=o;h.write&&r.add(a),h.read&&n.add(a)}}return s.readRelayUrls=Array.from(n),s.writeRelayUrls=Array.from(r),s}catch{}}var A,Ve=(A=class extends m{constructor(e,s){super(e,s);c(this,"debug");c(this,"_proofs",[]);c(this,"sender",this.author);this.kind??(this.kind=9321),this.debug=(e==null?void 0:e.debug.extend("nutzap"))??x("ndk:nutzap"),this.alt||(this.alt="This is a nutzap")}static from(e){const s=new this(e.ndk,e);try{const n=s.getMatchingTags("proof");n.length?s._proofs=n.map(r=>JSON.parse(r[1])):s._proofs=JSON.parse(s.content)}catch{return}if(!(!s._proofs||!s._proofs.length))return s}set comment(e){this.content=e??""}get comment(){const e=this.tagValue("comment");return e||this.content}set proofs(e){this._proofs=e,this.tags=this.tags.filter(s=>s[0]!=="proof");for(const s of e)this.tags.push(["proof",JSON.stringify(s)]);this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()])}get proofs(){return this._proofs}get p2pk(){var s;const e=this.proofs[0];try{const n=JSON.parse(e.secret);let r={};if(typeof n=="string"?(r=JSON.parse(n),this.debug("stringified payload",e.secret)):typeof n=="object"&&(r=n),r[0]==="P2PK"&&((s=r[1])==null?void 0:s.data)){const h=r[1].data.slice(2,-1);if(h)return h}}catch(n){this.debug("error parsing p2pk pubkey",n,this.proofs[0])}}get mint(){return this.tagValue("u")}set mint(e){this.removeTag("u"),this.tag(["u",e])}get unit(){return this.tagValue("unit")??"msat"}set unit(e){this.removeTag("unit"),e&&this.tag(["unit",e])}get amount(){return this.proofs.reduce((s,n)=>s+n.amount,0)*1e3}set target(e){this.tags=this.tags.filter(s=>s[0]!=="p"),e instanceof m&&this.tags.push()}set recipientPubkey(e){this.removeTag("p"),this.tag(["p",e])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const e=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:e}):new k({pubkey:e})}get isValid(){let e=0,s=0;for(const n of this.tags)n[0]==="p"&&e++,n[0]==="u"&&s++;return e===1&&s===1&&this.proofs.length>0}},c(A,"kind",9321),c(A,"kinds",[A.kind]),A);async function Oe(i){return await this.sendReq("pay_invoice",{invoice:i})}var He=class vt{constructor(t){c(this,"_user");c(this,"_privateKey");if(t){if(typeof t=="string")if(t.startsWith("nsec1")){const{type:e,data:s}=S.decode(t);e==="nsec"&&(this._privateKey=s)}else if(t.length===64)this._privateKey=dt(t);else throw new Error("Invalid private key provided.");else this._privateKey=t;this._privateKey&&(this._user=new k({pubkey:Nt(this._privateKey)}))}}get privateKey(){if(this._privateKey)return ut(this._privateKey)}static generate(){const t=Ut();return new vt(t)}async blockUntilReady(){if(!this._user)throw new Error("NDKUser not initialized");return this._user}async user(){return await this.blockUntilReady(),this._user}async sign(t){if(!this._privateKey)throw Error("Attempted to sign without a private key");return xt(t,this._privateKey).sig}getConversationKey(t){if(!this._privateKey)throw Error("Attempted to get conversation key without a private key");const e=t.pubkey;return K.getConversationKey(this._privateKey,e)}async nip44Encrypt(t,e){const s=this.getConversationKey(t);return await K.encrypt(e,s)}async nip44Decrypt(t,e){const s=this.getConversationKey(t);return await K.decrypt(e,s)}async encrypt(t,e,s=M){return s==="nip44"?this.nip44Encrypt(t,e):this.nip04Encrypt(t,e)}async decrypt(t,e,s=M){return s==="nip44"?this.nip44Decrypt(t,e):this.nip04Decrypt(t,e)}async nip04Encrypt(t,e){if(!this._privateKey)throw Error("Attempted to encrypt without a private key");const s=t.pubkey;return await j.encrypt(this._privateKey,s,e)}async nip04Decrypt(t,e){if(!this._privateKey)throw Error("Attempted to decrypt without a private key");const s=t.pubkey;return await j.decrypt(this._privateKey,s,e)}};async function qe(i,t){const e=new m(this.ndk,{kind:23194,tags:[["p",this.walletService.pubkey]],content:JSON.stringify({method:i,params:t})});return this.debug("Sending request",e.content),await e.encrypt(this.walletService,this.signer),await e.sign(this.signer),this.debug("Request encrypted and signed"),new Promise(async(s,n)=>{try{const r=e.tagId();if(!r)throw new Error("Failed to get e-tag");const a=h=>{this.off(r,a),this.off("event",a),this.debug("Received response",h);try{const l=JSON.parse(h);l.error&&n(l),s(l)}catch(l){this.debug("Failed to parse response",l),n({result_type:"error",error:{code:"failed_to_parse_response",message:l.message}})}},o=this.ndk.subscribe({kinds:[23195],"#e":[r],limit:1},{groupable:!1,subId:`nwc-${i}`},this.relaySet);o.on("event",async h=>{await h.decrypt(h.author,this.signer),a(h.content),o.stop()}),this.once(r,a),this.once("event",a),this.debug("Sending request to relay",e.rawEvent()),await e.publish(this.relaySet)}catch(r){this.debug("Failed to send request",r,r.relayErrors),n({result_type:"error",error:{code:"failed_to_send_request",message:r.message}})}})}async function We(){return await this.sendReq("get_balance",{})}async function Je(){return await this.sendReq("get_info",{})}var je=class Et extends N.EventEmitter{constructor({ndk:e,pubkey:s,relayUrls:n,secret:r}){super();c(this,"ndk");c(this,"debug");c(this,"walletService");c(this,"relaySet");c(this,"signer");c(this,"active",!1);c(this,"getBalance",We.bind(this));this.ndk=e,this.walletService=e.getUser({pubkey:s}),this.relaySet=new w(new Set(n.map(a=>e.pool.getRelay(a))),e),this.signer=new He(r instanceof Uint8Array?r:dt(r)),this.debug=e.debug.extend("nwc"),this.debug(`Starting with wallet service ${this.walletService.npub}`)}static async fromURI(e,s){const n=new URL(s);if(n.protocol!=="nostr+walletconnect:")throw new Error("Invalid protocol");return new Et({ndk:e,pubkey:n.host??n.pathname,relayUrls:n.searchParams.getAll("relay")??[""],secret:n.searchParams.get("secret")??""})}async blockUntilReady(e){const s=await this.signer.user(),n=new Promise((o,h)=>{setTimeout(()=>{h(new Error("Timeout"))},e)}),a=[new Promise(o=>{const h=this.ndk.subscribe({kinds:[23195],"#p":[s.pubkey],limit:1},{groupable:!1,subId:"nwc"},this.relaySet);h.on("event",async l=>{this.debug("received response",l.rawEvent());const u=l.tagValue("e");if(!u){this.debug("Received an event without an e-tag");return}this.debug("received an event",u);try{await l.decrypt(l.author,this.signer),this.emit(u,l.content)}catch(d){this.debug("Failed to decrypt event",d);return}}),h.on("eose",()=>{this.debug("Subscription ready"),this.active=!0,o()}),h.on("close",()=>{this.debug("Subscription closed"),this.active=!1})})];return e&&a.push(n),await Promise.race(a)}async sendReq(e,s){return await qe.call(this,e,s)}async payInvoice(e){return await Oe.call(this,e)}async getInfo(){return await Je.call(this)}};function Be(i,t){return i.created_at>t.created_at?i:t}async function Ye(i,t){return(await J([i],t)).get(i)}async function J(i,t,e=!1){var u;const s=t.outboxPool||t.pool,n=new Set;for(const d of s.relays.values())n.add(d);const r=new Map,a=new Map,o=new w(n,t);if((u=t.cacheAdapter)!=null&&u.locking&&!e){const d=await t.fetchEvents({kinds:[3,10002],authors:i},{cacheUsage:"ONLY_CACHE"});for(const f of d)f.kind===10002&&r.set(f.pubkey,W.from(f));for(const f of d)if(f.kind===3){if(r.has(f.pubkey))continue;const p=it(t,f);p&&a.set(f.pubkey,p)}i=i.filter(f=>!r.has(f)&&!a.has(f))}if(i.length===0)return r;const h=new Map,l=new Map;return new Promise(async d=>{const f=t.subscribe({kinds:[3,10002],authors:i},{closeOnEose:!0,pool:s,groupable:!0,cacheUsage:"ONLY_RELAY",subId:"ndk-relay-list-fetch"},o,!1);f.on("event",p=>{if(p.kind===10002){const y=h.get(p.pubkey);if(y&&y.created_at>p.created_at)return;h.set(p.pubkey,p)}else if(p.kind===3){const y=l.get(p.pubkey);if(y&&y.created_at>p.created_at)return;l.set(p.pubkey,p)}}),f.on("eose",()=>{for(const p of h.values())r.set(p.pubkey,W.from(p));for(const p of i){if(r.has(p))continue;const y=l.get(p);if(!y)continue;const g=it(t,y);g&&r.set(p,g)}d(r)}),f.start()})}var O=class{constructor(i){c(this,"type");c(this,"relayUrlScores");c(this,"readRelays");c(this,"writeRelays");this.type=i,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},Ze=class extends N.EventEmitter{constructor(t){super();c(this,"data");c(this,"ndk");c(this,"debug");this.ndk=t,this.debug=t.debug.extend("outbox-tracker"),this.data=new ft.LRUCache({maxSize:1e5,entryExpirationTimeInMS:2*60*1e3})}async trackUsers(t,e=!1){const s=[];for(let n=0;n<t.length;n+=400){const a=t.slice(n,n+400).map(o=>nt(o)).filter(o=>!this.data.has(o));if(a.length!==0){for(const o of a)this.data.set(o,new O("user"));s.push(new Promise(o=>{J(a,this.ndk,e).then(h=>{for(const[l,u]of h){let d=this.data.get(l);if(d??(d=new O("user")),u){d.readRelays=new Set(Z(u.readRelayUrls)),d.writeRelays=new Set(Z(u.writeRelayUrls));for(const f of d.readRelays)this.ndk.pool.blacklistRelayUrls.has(f)&&d.readRelays.delete(f);for(const f of d.writeRelays)this.ndk.pool.blacklistRelayUrls.has(f)&&d.writeRelays.delete(f);this.data.set(l,d)}}}).finally(o)}))}}return Promise.all(s)}track(t,e,s=!0){const n=nt(t);e??(e=Qe(t));let r=this.data.get(n);return r||(r=new O(e),t instanceof k&&this.trackUsers([t])),r}};function nt(i){return i instanceof k?i.pubkey:i}function Qe(i){return i instanceof k?"user":"kind"}var rt=class extends N.EventEmitter{constructor(t=[],e=[],s,n){super();c(this,"_relays",new Map);c(this,"autoConnectRelays",new Set);c(this,"blacklistRelayUrls");c(this,"debug");c(this,"temporaryRelayTimers",new Map);c(this,"flappingRelays",new Set);c(this,"backoffTimes",new Map);c(this,"ndk");this.debug=n??s.debug.extend("pool"),this.ndk=s,this.relayUrls=t,this.blacklistRelayUrls=new Set(e)}get relays(){return this._relays}set relayUrls(t){this._relays.clear();for(const e of t){const s=new P(e,void 0,this.ndk);this.addRelay(s,!1)}}set name(t){this.debug=this.debug.extend(t)}useTemporaryRelay(t,e=3e4,s){const n=this.relays.has(t.url);n||(this.addRelay(t),this.debug("Adding temporary relay %s for filters %o",t.url,s));const r=this.temporaryRelayTimers.get(t.url);if(r&&clearTimeout(r),!n||r){const a=setTimeout(()=>{var o;(o=this.ndk.explicitRelayUrls)!=null&&o.includes(t.url)||this.removeRelay(t.url)},e);this.temporaryRelayTimers.set(t.url,a)}}addRelay(t,e=!0){var g,R;const s=this.relays.has(t.url),n=(g=this.blacklistRelayUrls)==null?void 0:g.has(t.url),r=t.url.includes("/npub1");let a=!0;const o=t.url;if(s)return;if(n){this.debug(`Refusing to add relay ${o}: blacklisted`);return}if(r){this.debug(`Refusing to add relay ${o}: is a filter relay`);return}if((R=this.ndk.cacheAdapter)!=null&&R.getRelayStatus){const b=this.ndk.cacheAdapter.getRelayStatus(o);if(b&&b.dontConnectBefore)if(b.dontConnectBefore>Date.now()){const T=b.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${o}: delayed connect for ${T}ms`),setTimeout(()=>{this.addRelay(t,e)},T);return}else a=!1}const h=b=>this.emit("notice",t,b),l=()=>this.handleRelayConnect(o),u=()=>this.handleRelayReady(t),d=()=>this.emit("relay:disconnect",t),f=()=>this.handleFlapping(t),p=b=>this.emit("relay:auth",t,b),y=()=>this.emit("relay:authed",t);t.off("notice",h),t.off("connect",l),t.off("ready",u),t.off("disconnect",d),t.off("flapping",f),t.off("auth",p),t.off("authed",y),t.on("notice",h),t.on("connect",l),t.on("ready",u),t.on("disconnect",d),t.on("flapping",f),t.on("auth",p),t.on("authed",y),t.on("delayed-connect",b=>{var T;(T=this.ndk.cacheAdapter)!=null&&T.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(t.url,{dontConnectBefore:Date.now()+b})}),this.relays.set(o,t),e&&this.autoConnectRelays.add(o),e&&(this.emit("relay:connecting",t),t.connect(void 0,a).catch(b=>{this.debug(`Failed to connect to relay ${o}`,b)}))}removeRelay(t){const e=this.relays.get(t);if(e)return e.disconnect(),this.relays.delete(t),this.autoConnectRelays.delete(t),this.emit("relay:disconnect",e),!0;const s=this.temporaryRelayTimers.get(t);return s&&(clearTimeout(s),this.temporaryRelayTimers.delete(t)),!1}isRelayConnected(t){const e=E(t),s=this.relays.get(e);return s?s.status===5:!1}getRelay(t,e=!0,s=!1,n){let r=this.relays.get(E(t));return r||(r=new P(t,void 0,this.ndk),s?this.useTemporaryRelay(r,3e4,n):this.addRelay(r,e)),r}handleRelayConnect(t){this.emit("relay:connect",this.relays.get(t)),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(t){this.emit("relay:ready",t)}async connect(t){var n;const e=[];this.debug(`Connecting to ${this.relays.size} relays${t?`, timeout ${t}...`:""}`);const s=new Set(this.autoConnectRelays.keys());(n=this.ndk.explicitRelayUrls)==null||n.forEach(r=>{const a=E(r);s.add(a)});for(const r of s){const a=this.relays.get(r);if(!a)continue;const o=new Promise((h,l)=>(this.emit("relay:connecting",a),a.connect(t).then(h).catch(l)));if(t){const h=new Promise((l,u)=>{setTimeout(()=>u(`Timed out after ${t}ms`),t)});e.push(Promise.race([o,h]).catch(l=>{this.debug(`Failed to connect to relay ${a.url}: ${l??"No reason specified"}`)}))}else e.push(o)}t&&setTimeout(()=>{const r=this.stats().connected===this.relays.size,a=this.stats().connected>0;!r&&a&&this.emit("connect")},t),await Promise.all(e)}checkOnFlappingRelays(){const t=this.flappingRelays.size,e=this.relays.size;if(t/e>=.8)for(const s of this.flappingRelays)this.backoffTimes.set(s,0)}handleFlapping(t){this.debug(`Relay ${t.url} is flapping`);let e=this.backoffTimes.get(t.url)||5e3;e=e*2,this.backoffTimes.set(t.url,e),this.debug(`Backoff time for ${t.url} is ${e}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${t.url}`),this.emit("relay:connecting",t),t.connect(),this.checkOnFlappingRelays()},e),t.disconnect(),this.emit("flapping",t)}size(){return this.relays.size}stats(){const t={total:0,connected:0,disconnected:0,connecting:0};for(const e of this.relays.values())t.total++,e.status===5?t.connected++:e.status===1?t.disconnected++:e.status===4&&t.connecting++;return t}connectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status===5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5&&!this.temporaryRelayTimers.has(t.url))}urls(){return Array.from(this.relays.keys())}};function Ge(i,t){const e=t.connectedRelays();if(!Array.from(i.relays).some(n=>e.map(r=>r.url).includes(n.url)))for(const n of e)i.addRelay(n);if(e.length===0)for(const n of t.relays.values())i.addRelay(n);return i}function at(i){if(!i||i==="")return!1;try{return new URL(i),!0}catch{return!1}}async function Xe(i,t,e,s={type:"timeout"}){const n=this.debug.extend("fetch-event-from-tag"),[r,a,o]=i;e={},n("fetching event from tag",i,e,s);const h=F(this,t.pubkey);if(h&&h.size>0){n("fetching event from author relays %o",Array.from(h));const g=w.fromRelayUrls(Array.from(h),this),R=await this.fetchEvent(a,e,g);if(R)return R}else n("no author relays found for %s",t.pubkey,t);const l=H(this,[{ids:[a]}],this.pool);n("fetching event without relay hint",l);const u=await this.fetchEvent(a,e);if(u)return u;if(o&&o!==""){const g=await this.fetchEvent(a,e,this.pool.getRelay(o,!0,!0,[{ids:[a]}]));if(g)return g}let d;const f=at(o)?this.pool.getRelay(o,!1,!0,[{ids:[a]}]):void 0,p=new Promise(g=>{this.fetchEvent(a,e,f).then(g)});if(!at(o)||s.type==="none")return p;const y=new Promise(async g=>{const R=s.relaySet,b=s.timeout??1500,T=new Promise(z=>setTimeout(z,b));if(s.type==="timeout"&&await T,d)g(d);else{n("fallback fetch triggered");const z=await this.fetchEvent(a,e,R);g(z)}});switch(s.type){case"timeout":return Promise.race([p,y]);case"eose":return d=await p,d||y}}var ts="/.well-known/nostr/nip96.json",es=class{constructor(i,t){c(this,"ndk");c(this,"spec");c(this,"url");c(this,"nip98Required",!1);this.url=`https://${i}${ts}`,this.ndk=t}async prepareUpload(i,t="POST"){if(this.validateHttpFetch(),this.spec||await this.fetchSpec(),!this.spec)throw new Error("Failed to fetch NIP96 spec");let e={};return this.nip98Required&&(e={Authorization:await this.generateNip98Header(this.spec.api_url,t,i)}),{url:this.spec.api_url,headers:e}}async xhrUpload(i,t){const e="POST",{url:s,headers:n}=await this.prepareUpload(t,e);i.open(e,s,!0),n.Authorization&&i.setRequestHeader("Authorization",n.Authorization);const r=new FormData;return r.append("file",t),new Promise((a,o)=>{i.onload=function(){i.status>=200&&i.status<300?a(JSON.parse(i.responseText)):o(new Error(i.statusText))},i.onerror=function(){o(new Error("Network Error"))},i.send(r)})}async upload(i){const t="POST",{url:e,headers:s}=await this.prepareUpload(i,t),n=new FormData;n.append("file",i);const r=await this.ndk.httpFetch(this.spec.api_url,{method:t,headers:s,body:n});if(r.status!==200)throw new Error(`Failed to upload file to ${e}`);const a=await r.json();if(a.status!=="success")throw new Error(a.message);return a}validateHttpFetch(){if(!this.ndk)throw new Error("NDK is required to fetch NIP96 spec");if(!this.ndk.httpFetch)throw new Error("NDK must have an httpFetch method to fetch NIP96 spec")}async fetchSpec(){this.validateHttpFetch();const i=await this.ndk.httpFetch(this.url);if(i.status!==200)throw new Error(`Failed to fetch NIP96 spec from ${this.url}`);const t=await i.json();if(!t)throw new Error(`Failed to parse NIP96 spec from ${this.url}`);this.spec=t,this.nip98Required=this.spec.plans.free.is_nip98_required}async generateNip98Header(i,t,e){const s=new m(this.ndk,{kind:27235,tags:[["u",i],["method",t]]});if(["POST","PUT","PATCH"].includes(t)){const r=await this.calculateSha256(e);s.tags.push(["payload",r])}return await s.sign(),`Nostr ${btoa(JSON.stringify(s.rawEvent()))}`}async calculateSha256(i){const t=await i.arrayBuffer(),e=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(e)).map(r=>r.toString(16).padStart(2,"0")).join("")}},ot=class{constructor(i,t){c(this,"queue",[]);c(this,"maxConcurrency");c(this,"processing",new Set);c(this,"promises",new Map);this.maxConcurrency=t}add(i){if(this.promises.has(i.id))return this.promises.get(i.id);const t=new Promise((e,s)=>{this.queue.push({...i,func:()=>i.func().then(n=>(e(n),n),n=>{throw s(n),n})}),this.process()});return this.promises.set(i.id,t),t.finally(()=>{this.promises.delete(i.id),this.processing.delete(i.id),this.process()}),t}process(){if(this.processing.size>=this.maxConcurrency||this.queue.length===0)return;const i=this.queue.shift();!i||this.processing.has(i.id)||(this.processing.add(i.id),i.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},ss=class{constructor(i){c(this,"subscriptions");c(this,"seenEvents",new Map);c(this,"debug");this.subscriptions=new Map,this.debug=i.extend("sub-manager")}add(i){this.subscriptions.set(i.internalId,i),i.on("close",()=>{this.subscriptions.delete(i.internalId)})}seenEvent(i,t){const e=this.seenEvents.get(i)||[];e.push(t),this.seenEvents.set(i,e)}},Tt=x("ndk:active-user");async function is(i){if(!this.autoConnectUserRelays)return;const t=await Ye(i.pubkey,this);if(t){for(const e of t.relays){let s=this.pool.relays.get(e);s||(s=new P(e,this.relayAuthDefaultPolicy,this),this.pool.addRelay(s))}return t}}async function ns(i){const t=this.outboxPool||this.pool;t.connectedRelays.length>0?ct.call(this,i):t.once("connect",()=>{ct.call(this,i)})}async function ct(i){const t=await is.call(this,i),e=[{kinds:[10006],authors:[i.pubkey]}];this.autoFetchUserMutelist&&e[0].kinds.push(1e4);const s=t?t.relaySet:void 0,n=this.subscribe(e,{subId:"active-user-settings",closeOnEose:!0},s,!1),r=new Map;n.on("event",a=>{const o=r.get(a.kind);o&&o.created_at>=a.created_at||r.set(a.kind,a)}),n.on("eose",()=>{for(const a of r.values())rs.call(this,a)}),n.start()}async function rs(i){i.kind===10006?as.call(this,i):i.kind===1e4&&os.call(this,i)}function as(i){const t=kt.from(i);for(const e of t.items)this.pool.blacklistRelayUrls.add(e[0]);Tt("Added %d relays to relay blacklist",t.items.length)}function os(i){const t=kt.from(i);for(const e of t.items)this.mutedIds.set(e[1],e[0]);Tt("Added %d users to mute list",t.items.length)}async function cs(i,t,e,s,n,r,a,o,h){const l=e.callback,u=Ct.makeZapRequest({profile:s,event:null,amount:n,comment:a||"",relays:r.slice(0,4)});if(i instanceof m){const p=i.referenceTags().filter(y=>y[0]!=="p");u.tags.push(...p)}u.tags.push(["lnurl",l]);const d=new m(t,u);return o&&(d.tags=d.tags.concat(o)),d.tags=d.tags.filter(f=>f[0]!=="p"),d.tags.push(["p",s]),await d.sign(h),d}var v=x("ndk:zapper"),hs=class extends N.EventEmitter{constructor(t,e,s="msat",n,r,a,o){super();c(this,"target");c(this,"ndk");c(this,"comment");c(this,"amount");c(this,"unit");c(this,"tags");c(this,"signer");c(this,"zapMethod");c(this,"onLnPay");c(this,"onCashuPay");c(this,"onComplete");c(this,"maxRelays",3);if(this.target=t,this.ndk=r||t.ndk,!this.ndk)throw new Error("No NDK instance provided");this.amount=e,this.comment=n,this.unit=s,this.tags=a,this.signer=o}async zap(){const t=this.getZapSplits(),e=new Map;return await Promise.all(t.map(async s=>{let n;try{n=await this.zapSplit(s)}catch(r){n=r}this.emit("split:complete",s,n),e.set(s,n)})),this.emit("complete",e),this.onComplete&&this.onComplete(e),e}async zapSplit(t){let e=await this.getZapMethods(this.ndk,t.pubkey),s;if(e.length===0)throw new Error("No zap method available for recipient");e=e.sort((r,a)=>r.type==="nip61"?-1:a.type==="nip61"?1:0);const n=await this.relays(t.pubkey);for(const r of e){v("Zapping to %s with %d %s using %s",t.pubkey,t.amount,this.unit,r.type);try{switch(r.type){case"nip61":{const a=r.data;let o;if(o=await this.onCashuPay({target:this.target,comment:this.comment,tags:this.tags,recipientPubkey:t.pubkey,amount:t.amount,unit:this.unit,...a}),v("NIP-61 Zap result: %o",o),o instanceof Error)s=o;else if(o){const{proofs:h,mint:l}=o;if(!h||!l)throw new Error("Invalid zap confirmation: missing proofs or mint: "+o);const u=w.fromRelayUrls(n,this.ndk),d=new Ve(this.ndk);return d.tags=[...d.tags,...this.tags||[]],d.proofs=h,d.mint=l,d.comment=this.comment,d.unit=this.unit,d.recipientPubkey=t.pubkey,await d.sign(this.signer),await d.publish(u),d}break}case"nip57":{const a=r.data,o=await cs(this.target,this.ndk,a,t.pubkey,t.amount,n,this.comment,this.tags,this.signer);if(!o)throw v("Unable to generate zap request"),new Error("Unable to generate zap request");const h=await this.getLnInvoice(o,t.amount,a);if(!h)throw v("Unable to get payment request"),new Error("Unable to get payment request");s=await this.onLnPay({target:this.target,comment:this.comment,recipientPubkey:t.pubkey,amount:t.amount,unit:this.unit,pr:h});break}}}catch(a){a instanceof Error?s=a:s=new Error(a),v("Error zapping to %s with %d %s using %s: %o",t.pubkey,t.amount,this.unit,r.type,a)}}if(s instanceof Error)throw s;return s}async getLnInvoice(t,e,s){const n=s.callback,r=JSON.stringify(t.rawEvent());v(`Fetching invoice from ${n}?`+new URLSearchParams({amount:e.toString(),nostr:r}));const a=new URL(n);a.searchParams.append("amount",e.toString()),a.searchParams.append("nostr",r),v(`Fetching invoice from ${a.toString()}`);const o=await fetch(a.toString());if(v(`Got response from zap endpoint: ${n}`,{status:o.status}),o.status!==200){v(`Received non-200 status from zap endpoint: ${n}`,{status:o.status,amount:e,nostr:r});const l=await o.text();throw new Error(`Unable to fetch zap endpoint ${n}: ${l}`)}return(await o.json()).pr}getZapSplits(){if(this.target instanceof k)return[{pubkey:this.target.pubkey,amount:this.amount}];const t=this.target.getMatchingTags("zap");if(t.length===0)return[{pubkey:this.target.pubkey,amount:this.amount}];const e=[],s=t.reduce((n,r)=>n+parseInt(r[2]),0);for(const n of t){const r=n[1],a=Math.floor(parseInt(n[2])/s*this.amount);e.push({pubkey:r,amount:a})}return e}async getZapMethods(t,e){const s=[];s.push("nip61"),s.push("nip57");const n=t.getUser({pubkey:e}),r=await n.getZapInfo(!1,s);return v("Zap info for %s: %o",n.npub,r),r}async relays(t){var s,n,r;let e=[];if((s=this.ndk)!=null&&s.activeUser){const a=await J([this.ndk.activeUser.pubkey,t],this.ndk),o=new Map;for(const h of a.values())for(const l of h.readRelayUrls){const u=o.get(l)||0;o.set(l,u+1)}e=Array.from(o.entries()).sort((h,l)=>l[1]-h[1]).map(([h])=>h).slice(0,this.maxRelays)}return(r=(n=this.ndk)==null?void 0:n.pool)!=null&&r.permanentAndConnectedRelays().length&&(e=this.ndk.pool.permanentAndConnectedRelays().map(a=>a.url)),e.length||(e=[]),e}},ls=["wss://purplepag.es/","wss://nos.lol/"],ht=["wss://brb.io/","wss://nostr.mutinywallet.com/"],ws=class extends N.EventEmitter{constructor(t={}){super();c(this,"_explicitRelayUrls");c(this,"pool");c(this,"outboxPool");c(this,"_signer");c(this,"_activeUser");c(this,"cacheAdapter");c(this,"debug");c(this,"devWriteRelaySet");c(this,"outboxTracker");c(this,"mutedIds");c(this,"clientName");c(this,"clientNip89");c(this,"queuesZapConfig");c(this,"queuesNip05");c(this,"asyncSigVerification",!1);c(this,"initialValidationRatio",1);c(this,"lowestValidationRatio",1);c(this,"validationRatioFn");c(this,"subManager");c(this,"publishingFailureHandled",!1);c(this,"relayAuthDefaultPolicy");c(this,"httpFetch");c(this,"autoConnectUserRelays",!0);c(this,"autoFetchUserMutelist",!0);c(this,"walletConfig");c(this,"fetchEventFromTag",Xe.bind(this));this.debug=t.debug||x("ndk"),this._explicitRelayUrls=t.explicitRelayUrls||[],this.subManager=new ss(this.debug),this.pool=new rt(t.explicitRelayUrls||[],t.blacklistRelayUrls||ht,this),this.pool.name="main",this.pool.on("relay:auth",async(e,s)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(e,s)}),this.autoConnectUserRelays=t.autoConnectUserRelays??!0,this.autoFetchUserMutelist=t.autoFetchUserMutelist??!0,this.clientName=t.clientName,this.clientNip89=t.clientNip89,this.relayAuthDefaultPolicy=t.relayAuthDefaultPolicy,t.enableOutboxModel&&(this.outboxPool=new rt(t.outboxRelayUrls||ls,t.blacklistRelayUrls||ht,this,this.debug.extend("outbox-pool")),this.outboxPool.name="outbox",this.outboxTracker=new Ze(this)),this.signer=t.signer,this.cacheAdapter=t.cacheAdapter,this.mutedIds=t.mutedIds||new Map,t.devWriteRelayUrls&&(this.devWriteRelaySet=w.fromRelayUrls(t.devWriteRelayUrls,this)),this.queuesZapConfig=new ot("zaps",3),this.queuesNip05=new ot("nip05",10),this.signatureVerificationWorker=t.signatureVerificationWorker,this.initialValidationRatio=t.initialValidationRatio||1,this.lowestValidationRatio=t.lowestValidationRatio||1;try{this.httpFetch=fetch}catch{}}set explicitRelayUrls(t){this._explicitRelayUrls=t,this.pool.relayUrls=t}get explicitRelayUrls(){return this._explicitRelayUrls||[]}set signatureVerificationWorker(t){this.asyncSigVerification=!!t,t&&be(t)}addExplicitRelay(t,e,s=!0){let n;return typeof t=="string"?n=new P(t,e,this):n=t,this.pool.addRelay(n,s),this.explicitRelayUrls.push(n.url),n}toJSON(){return{relayCount:this.pool.relays.size}.toString()}get activeUser(){return this._activeUser}set activeUser(t){var s;const e=((s=this._activeUser)==null?void 0:s.pubkey)!==(t==null?void 0:t.pubkey);this._activeUser=t,t&&e?ns.call(this,t):t||(this.mutedIds=new Map)}get signer(){return this._signer}set signer(t){this._signer=t,t&&this.emit("signer:ready",t),t==null||t.user().then(e=>{e.ndk=this,this.activeUser=e})}async connect(t){var s,n;this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await((n=(s=this._signer).relays)==null?void 0:n.call(s,this))),this._signer.relays&&(await this._signer.relays(this)).forEach(a=>this.pool.addRelay(a)));const e=[this.pool.connect(t)];return this.outboxPool&&e.push(this.outboxPool.connect(t)),this.debug("Connecting to relays %o",{timeoutMs:t}),Promise.allSettled(e).then(()=>{})}getUser(t){const e=new k(t);return e.ndk=this,e}async getUserFromNip05(t,e=!1){return k.fromNip05(t,this,e)}subscribe(t,e,s,n=!0){var a;const r=new Ie(this,t,e,s);if(this.subManager.add(r),s)for(const o of s.relays)this.pool.useTemporaryRelay(o,void 0,r.filters);if(this.outboxPool&&r.hasAuthorsFilter()){const o=r.filters.filter(h=>{var l;return h.authors&&((l=h.authors)==null?void 0:l.length)>0}).map(h=>h.authors).flat();(a=this.outboxTracker)==null||a.trackUsers(o)}return n&&setTimeout(()=>r.start(),0),r}async publish(t,e,s){return this.debug("Deprecated: Use `event.publish()` instead"),t.publish(e,s)}async fetchEvent(t,e,s){let n,r;if(s instanceof P?r=new w(new Set([s]),this):s instanceof w&&(r=s),!s&&typeof t=="string"&&!Ne(t)){const a=xe(t,this);a.length>0&&(r=new w(new Set(a),this),r=Ge(r,this.pool))}if(typeof t=="string"?n=[Pe(t)]:Array.isArray(t)?n=t:n=[t],n.length===0)throw new Error(`Invalid filter: ${JSON.stringify(t)}`);return new Promise(a=>{let o=null;const h=this.subscribe(n,{...e||{},closeOnEose:!0},r,!1),l=setTimeout(()=>{h.stop(),a(o)},1e4);h.on("event",u=>{u.ndk=this,u.isReplaceable()?(!o||o.created_at<u.created_at)&&(o=u):(clearTimeout(l),a(u))}),h.on("eose",()=>{clearTimeout(l),a(o)}),h.start()})}async fetchEvents(t,e,s){return new Promise(n=>{const r=new Map,a=this.subscribe(t,{...e||{},closeOnEose:!0},s,!1),o=h=>{h instanceof m||(h=new m(void 0,h));const l=h.deduplicationKey(),u=r.get(l);u&&(h=Be(u,h)),h.ndk=this,r.set(l,h)};a.on("event",o),a.on("eose",()=>{n(new Set(r.values()))}),a.start()})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),new Error("Signer required")}getNip96(t){return new es(t,this)}async nwc(t,e=2e3){const s=await je.fromURI(this,t);return e!==!1&&await s.blockUntilReady(e),s}zap(t,e,{comment:s,unit:n,signer:r,tags:a,onLnPay:o,onCashuPay:h,onComplete:l}){var d,f,p;r||this.assertSigner();const u=new hs(t,e,n,s,this,a,r);return o!==!1&&(u.onLnPay=o??((d=this.walletConfig)==null?void 0:d.onLnPay)),h!==!1&&(u.onCashuPay=h??((f=this.walletConfig)==null?void 0:f.onCashuPay)),u.onComplete=l??((p=this.walletConfig)==null?void 0:p.onPaymentComplete),o&&u.zap(),u}};export{ws as N};
